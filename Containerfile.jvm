FROM eclipse-temurin:17-jre-ubi9-minimal AS runtime
WORKDIR /spring-app
COPY bin/spring-app.jar app.jar
COPY deploy/java-entrypoint.sh /usr/local/bin/java-entrypoint.sh
RUN java -Djarmode=tools -jar app.jar extract --layers --destination extracted
RUN groupadd --gid 1000 appgroup \
    && useradd --uid 1000 --gid 1000 --create-home appuser
RUN chmod +x /usr/local/bin/java-entrypoint.sh
RUN chown appuser:appgroup --recursive /spring-app
USER appuser
ENTRYPOINT ["java-entrypoint.sh"]
